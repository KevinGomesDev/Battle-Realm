generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  // Estatísticas de Batalhas PvP
  battleWins   Int @default(0)
  battleLosses Int @default(0)

  // Estatísticas de Partidas
  matchWins   Int @default(0)
  matchLosses Int @default(0)

  kingdoms  Kingdom[]
  matches   MatchKingdom[]
}

model Kingdom {
  id             String    @id @default(uuid())
  name           String
  description    String?   // História ou descrição do reino (opcional)
  alignment      Alignment
  race           Race
  ownerId        String
  owner          User      @relation(fields: [ownerId], references: [id])
  // Relação direta com o Regente do Reino
  regentId       String?   @unique
  regent         Unit?     @relation("KingdomRegent", fields: [regentId], references: [id])
  // Templates das 5 tropas (permanentes)
  troopTemplates TroopTemplate[]
  // Histórico de partidas (resumo)
  matchHistory   MatchHistory[]
  // Partidas em que este reino participou
  matchKingdoms  MatchKingdom[]
  createdAt      DateTime  @default(now())
}

// Template de Tropa - Definido na criação do Reino
model TroopTemplate {
  id             String    @id @default(uuid())
  kingdomId      String
  kingdom        Kingdom   @relation(fields: [kingdomId], references: [id], onDelete: Cascade)
  slotIndex      Int       // 0-4 (5 tropas por reino)
  name           String    // Nome personalizado da tropa
  description    String?   // História ou descrição da tropa (opcional)
  avatar         String?   // ID do sprite (ex: "[1].png")
  passiveId      String    // ID da passiva escolhida
  resourceType   String    // minerio, suprimentos, arcana, experiencia
  // Atributos base (10 pontos distribuídos)
  combat         Int       @default(2)
  speed          Int       @default(2)
  focus          Int       @default(2)
  resistance     Int       @default(2)
  will           Int       @default(0)
  vitality       Int       @default(2)
  
  @@unique([kingdomId, slotIndex])
}

enum Alignment {
  BOM
  MAL
  NEUTRO
}

enum Race {
  ABERRACAO
  BESTA
  CELESTIAL
  CONSTRUTO
  DRAGAO
  ELEMENTAL
  FADA
  DIABO
  GIGANTE
  HUMANOIDE
  MONSTRUOSIDADE
  GOSMA
  PLANTA
  MORTO_VIVO
  INSETO
}

model Match {
  id             String   @id @default(uuid())
  status         String   @default("WAITING")
  maxPlayers     Int      @default(2)
  currentRound   Int      @default(1)
  currentTurn    TurnType @default(ADMINISTRACAO)
  crisisMeter    Int      @default(0)
  crisisState    String?
  recruitedHeroes String  @default("[]") // Códigos de heróis já recrutados nesta partida (JSON array)
  players        MatchKingdom[]
  territories    Territory[]
  units          Unit[]
  structures     Structure[]
  battles        Battle[]
  events         GameEvent[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// Histórico de partidas (resumo para o Reino)
model MatchHistory {
  id             String   @id @default(uuid())
  kingdomId      String
  kingdom        Kingdom  @relation(fields: [kingdomId], references: [id])
  matchDate      DateTime @default(now())
  result         String   // WIN | LOSS | DRAW
  opponentName   String   // Nome do reino oponente
  opponentRace   String   // Raça do oponente
  finalRound     Int      // Rodada em que a partida terminou
  summary        String   @default("{}") // JSON: estatísticas extras (unidades perdidas, etc)
}

// Reino participando de uma partida
model MatchKingdom {
  id             String   @id @default(uuid())
  matchId        String
  match          Match    @relation(fields: [matchId], references: [id])
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  kingdomId      String
  kingdom        Kingdom  @relation(fields: [kingdomId], references: [id])
  playerIndex    Int      @default(0)        // 0 = Host, 1 = Guest (define cor)
  playerColor    String   @default("#ff0000") // Vermelho padrão
  isReady        Boolean  @default(false)    // Pronto na fase de preparação
  freeBuildingsUsed Int   @default(0)        // Construções gratuitas usadas na preparação (máx 3)
  capitalTerritoryId String?                 // Território inicial/capital
  locationIndex  Int?                        // Posição no mapa (definida durante partida)
  troopLevels    String   @default("{}")
  troopTemplates String   @default("{}")
  customChoices  String   @default("{}")
  raceMetadata   String?                     // Metadata da raça (ex: elementos para Elemental)
  inventory      String   @default("[]")     // Itens do reino durante esta partida (JSON)
  resources      String   @default("{\"ore\":0,\"supplies\":0,\"arcane\":0,\"experience\":0,\"devotion\":0}")
  hasPlayedTurn  Boolean  @default(false)
  hasFinishedAdminTurn Boolean @default(false)
  unitCount      Int      @default(0)
  buildingCount  Int      @default(0)
  units          Unit[]
  structures     Structure[]
  battleUnits    BattleUnit[]
}

model Territory {
  id             String        @id @default(uuid())
  matchId        String
  match          Match         @relation(fields: [matchId], references: [id])
  mapIndex       Int
  centerX        Float         @default(0)
  centerY        Float         @default(0)
  type           String
  terrainType    String
  polygonData    String
  size           TerritorySize @default(MEDIUM)
  areaSlots      Int           @default(10)
  usedSlots      Int           @default(0)
  ownerId        String?       // ID do MatchKingdom que controla (null = selvagem)
  isCapital      Boolean       @default(false) // É a capital de algum jogador?
  hasCrisisIntel Boolean       @default(false)
  constructionCount Int        @default(0)     // Total de construções (Produtores + Fortalezas)
  fortressCount  Int           @default(0)     // Apenas fortalezas (máximo 3)
  isDisabled     Boolean       @default(false)
}

model Unit {
  id             String      @id @default(uuid())
  // Vinculação à Partida (quando em partida)
  matchId        String?
  match          Match?      @relation(fields: [matchId], references: [id])
  // Vinculação ao Reino na Partida (MatchKingdom)
  ownerId        String?
  owner          MatchKingdom? @relation(fields: [ownerId], references: [id])
  // Relação inversa: Este Unit pode ser o Regente de um Kingdom
  regentOfKingdom Kingdom?   @relation("KingdomRegent")
  name           String?
  description    String?     // História ou descrição do herói/regente (opcional)
  equipment      String      @default("[]") // Itens equipados (máx 3) (JSON)
  // Relacionamentos de unidades
  summonerId     String?
  summoner       Unit?        @relation("Summons", fields: [summonerId], references: [id])
  summons        Unit[]       @relation("Summons")
  battleUnits    BattleUnit[]
  // Dados da Unidade
  category       UnitCategory
  troopSlot      Int?         // Para TROOP: índice do template de tropa (0-4)
  level          Int          @default(1)
  experience     Int          @default(0) // XP acumulada - ao atingir thresholds, sobe de nível
  // Avatar (nome do arquivo sprite em public/sprites/Characters)
  avatar         String?      // ID do sprite (ex: "[1].png")
  // Classe do Herói (código string, ex: BARBARIAN, WARRIOR) - Regentes NÃO possuem classe
  classCode      String?      // Código da classe (dados em server/src/data/classes.data.ts)
  features       String       @default("[]") // Skills aprendidas (JSON array)
  spells         String       @default("[]") // Códigos das spells disponíveis (concedidas via eventos/skills)
  // Condições permanentes da unidade (ex: buffs de eventos, maldições, etc)
  conditions     String       @default("[]") // Códigos das condições ativas (JSON array)
  // Hotbar - Barra de atalhos (1-9 e Shift+1-9) - JSON: UnitHotbarConfig
  hotbar         String       @default("{}") // { primary: [9 slots], secondary: [9 slots] }
  combat         Int
  speed          Int
  focus          Int
  resistance     Int
  will           Int
  vitality       Int
  damageReduction Int         @default(0) // Redução de dano fixa (armadura pesada, raça, etc.)
  maxHp          Int                       // HP máximo (Vitality * HP_CONFIG.multiplier)
  currentHp      Int
  maxMana        Int          @default(0)  // Mana máximo (Will * MANA_CONFIG.multiplier)
  currentMana    Int          @default(0)  // Mana atual
  isAlive        Boolean      @default(true) // Morte permanente em partidas
  locationIndex  Int?
  
  // === NEMESIS SYSTEM ===
  // Identificador único se esta unidade é/foi um Nemesis
  nemesisId           String?     // ID do Nemesis (se for um)
}

model Structure {
  id             String      @id @default(uuid())
  // Vinculação à Partida (quando em partida)
  matchId        String?
  match          Match?      @relation(fields: [matchId], references: [id])
  // Vinculação ao Reino na Partida (MatchKingdom)
  ownerId        String?
  owner          MatchKingdom? @relation(fields: [ownerId], references: [id])
  // Dados da Estrutura
  type           String
  maxHp          Int
  currentHp      Int
  resourceType   String?
  productionRate Int
  locationIndex  Int?
}

enum UnitCategory {
  TROOP
  HERO
  REGENT
  SUMMON
  MONSTER
}

enum TerritorySize {
  SMALL
  MEDIUM
  LARGE
}

enum TurnType {
  ADMINISTRACAO
  EXERCITOS
  MOVIMENTACAO
  CRISE
  ACAO
  BATALHA
}

// =====================
// Battle System Models
// =====================

// Battle Lobby - Sala de espera para batalhas PvP
model BattleLobby {
  id             String   @id @default(uuid())
  hostUserId     String
  hostSocketId   String   @default("")
  hostKingdomId  String
  hostUsername   String   @default("")
  hostKingdomName String  @default("")
  status         String   @default("WAITING") // WAITING | READY | BATTLING | ENDED
  battleId       String?  // ID da batalha quando status = BATTLING
  maxPlayers     Int      @default(2)  // Número máximo de jogadores
  players        String   @default("[]") // JSON array de jogadores [{userId, kingdomId, ...}]
  vsBot          Boolean  @default(false) // Se é uma partida contra bot
  events         GameEvent[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Battle {
  id               String   @id @default(uuid())
  matchId          String?  // Null para batalhas PvP
  match            Match?   @relation(fields: [matchId], references: [id])
  isPvP            Boolean  @default(false)    // True se é batalha PvP (não de partida)
  lobbyId          String?  // ID do lobby (se aplicável)
  hostUserId       String?  // ID do host
  guestUserId      String?  // ID do guest
  hostKingdomId    String?  // ID do reino do host
  guestKingdomId   String?  // ID do reino do guest
  status           String   @default("ACTIVE") // ACTIVE | PAUSED | ENDED
  gridWidth        Int      @default(20)
  gridHeight       Int      @default(20)
  round            Int      @default(1)
  currentTurnIndex Int      @default(0)        // índice na ordem de iniciativa
  actionOrder      String   @default("[]")      // JSON: [unitId...], ordem de unidades por iniciativa
  activeUnitId     String?  // ID da unidade com turno ativo
  currentPlayerId  String?  // ID do jogador com turno ativo
  turnTimer        Int      @default(60)       // Segundos restantes no turno
  winnerId         String?  // ID do vencedor (userId ou matchKingdomId)
  winReason        String?  // Motivo da vitória
  ransomPrice      Int?
  ransomResource   String?
  // Clima e Terreno
  terrainType      String   @default("PLAINS")  // FOREST | PLAINS | MOUNTAIN | DESERT | ICE | WASTELAND | SWAMP | RUINS
  territorySize    TerritorySize   @default(MEDIUM)  // SMALL | MEDIUM | LARGE
  obstacles        String   @default("[]")      // JSON: [{id, posX, posY, emoji}...]
  // Multi-player support
  maxPlayers       Int      @default(2)           // Número máximo de jogadores
  playerIds        String   @default("[]")       // JSON: [userId1, userId2, ...]
  kingdomIds       String   @default("[]")       // JSON: [kingdomId1, kingdomId2, ...]
  playerColors     String   @default("[]")       // JSON: ["#color1", "#color2", ...]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  units            BattleUnit[]
  events           GameEvent[]
}

model BattleUnit {
  id          String      @id @default(uuid())
  battleId    String
  battle      Battle      @relation(fields: [battleId], references: [id], onDelete: Cascade)
  unitId      String?     // Reference to original Unit (null for PvP where units are temporary)
  unit        Unit?       @relation(fields: [unitId], references: [id])
  ownerId     String?     // MatchKingdom ID (for matches)
  owner       MatchKingdom? @relation(fields: [ownerId], references: [id])
  // Data copied from Unit for battle
  unitBattleId String?    // ID da unidade na batalha (diferente do id do banco)
  userId      String?     // Owner User ID (for PvP battles)
  kingdomId   String?     // Owner Kingdom ID
  name        String      @default("Unit")
  avatar      String?     // ID do sprite (ex: "[1].png")
  category    String      @default("TROOP")
  troopSlot   Int?        // Para TROOP: índice do template (0-4)
  level       Int         @default(1)  // Nível da unidade
  race        String?     // Raça da unidade (ex: HUMAN, ORC)
  classCode   String?     // Código da classe (ex: BARBARIAN, WARRIOR)
  features    String      @default("[]") // Skills/features da unidade (JSON) - actions disponíveis
  equipment   String      @default("[]") // Itens equipados (JSON)
  spells      String      @default("[]") // Códigos das spells disponíveis (JSON)
  combat      Int         @default(1)
  speed       Int         @default(1)
  focus       Int         @default(1)
  resistance  Int         @default(1)
  will        Int         @default(0)
  vitality    Int         @default(5)
  damageReduction Int     @default(0) // Fixed DR, most units have 0
  maxHp       Int         @default(10)  // Max HP (stored, can be modified by passives)
  currentHp   Int         @default(10)  // Current HP
  maxMana     Int         @default(0)   // Max Mana (stored, can be modified by passives)
  currentMana Int         @default(0)   // Current Mana
  // Battle state
  posX        Int         @default(0)
  posY        Int         @default(0)
  movesLeft   Int         @default(3)
  actionsLeft Int         @default(1)
  attacksLeftThisTurn Int @default(0)          // Ataques restantes neste turno (extraAttacks)
  isAlive     Boolean     @default(true)
  actionMarks Int         @default(0)          // Action Marks restantes (decrementadas ao usar ação)
  physicalProtection     Int  @default(0)
  maxPhysicalProtection  Int  @default(0)      // Max proteção física
  magicalProtection      Int  @default(0)
  maxMagicalProtection   Int  @default(0)      // Max proteção mágica
  conditions  String      @default("[]")        // JSON: ["FROZEN", ...]
  grabbedByBattleUnitId String?
  hasStartedAction Boolean @default(false)     // If unit already started action this turn
  isAIControlled Boolean  @default(false)     // If true, AI controls this unit (funnel)
  aiBehavior  String      @default("AGGRESSIVE") // Comportamento da IA (AGGRESSIVE, DEFENSIVE, etc)
  // Unit size and vision
  size        String      @default("MEDIUM")   // SMALL | MEDIUM | LARGE | HUGE | GARGANTUAN
  visionRange Int         @default(10)         // Vision range (max(10, focus))
  // Skill/Spell cooldowns
  unitCooldowns String     @default("{}")       // JSON: { "CODE": roundsLeft }
  // Hotbar - Barra de atalhos (copiada do Unit original)
  hotbar        String     @default("{}")       // JSON: UnitHotbarConfig { primary, secondary }
  // Active effects (efeitos temporários como buffs/debuffs)
  activeEffects String     @default("{}")       // JSON: { effectKey: { key, value, sources } }
  
  // === NEMESIS SYSTEM ===
  // Se esta unidade é um Nemesis, carrega dados para narrativa emergente
  nemesisId           String?                    // ID do Nemesis (referência)
  isNemesis           Boolean    @default(false) // Flag rápida para identificar Nemesis
  nemesisRank         String?                    // GRUNT | CAPTAIN | ELITE | WARLORD | OVERLORD
  nemesisPowerLevel   Int        @default(0)     // Nível de poder do Nemesis
  nemesisTraits       String     @default("[]") // JSON: PersonalityTrait[]
  nemesisFears        String     @default("[]") // JSON: NemesisFear[]
  nemesisStrengths    String     @default("[]") // JSON: NemesisStrength[]
  nemesisScars        String     @default("[]") // JSON: ScarType[]
  nemesisTitle        String?                    // Título conquistado
  nemesisKillCount    Int        @default(0)     // Quantas vezes matou o jogador alvo
  nemesisTargetPlayer String?                    // ID do jogador que é alvo
}

// =============================================================================
// SISTEMA DE EVENTOS
// =============================================================================

model GameEvent {
  id          String   @id @default(uuid())
  timestamp   DateTime @default(now())
  
  // Contexto e escopo
  context     String   // GLOBAL | MATCH | BATTLE | ACCOUNT
  scope       String   // GLOBAL | INDIVIDUAL
  category    String   // SYSTEM | COMBAT | MOVEMENT | CONDITION | TURN | SKILL | ITEM | RESOURCE | KINGDOM | MATCH | BATTLE | ACCOUNT
  severity    String   @default("INFO") // INFO | SUCCESS | WARNING | DANGER | NEUTRAL
  
  // Relacionamentos (apenas um preenchido por vez)
  matchId       String?
  match         Match?      @relation(fields: [matchId], references: [id], onDelete: Cascade)
  battleId      String?
  battle        Battle?     @relation(fields: [battleId], references: [id], onDelete: Cascade)
  battleLobbyId  String?
  battleLobby    BattleLobby? @relation(fields: [battleLobbyId], references: [id], onDelete: Cascade)
  
  // Destinatários
  targetUserIds String   @default("[]") // JSON: ["userId1", "userId2"] - Se scope=INDIVIDUAL
  sourceUserId  String?  // Usuário que originou o evento
  
  // Conteúdo
  message   String   // Mensagem principal para exibição
  code      String   // Código identificador (ex: ATTACK_DODGED)
  data      String   @default("{}") // JSON: dados extras
  
  // Unidades envolvidas (para eventos de combate)
  actorId   String?
  actorName String?
  targetId  String?
  targetName String?
  
  // Índices otimizados para queries comuns
  @@index([matchId, timestamp(sort: Desc)])
  @@index([battleId, timestamp(sort: Desc)])
  @@index([battleLobbyId, timestamp(sort: Desc)])
  @@index([context, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])  // Para paginação e cleanup
}