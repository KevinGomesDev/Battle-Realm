generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  // Estatísticas de Arena
  arenaWins   Int @default(0)
  arenaLosses Int @default(0)

  // Estatísticas de Partidas
  matchWins   Int @default(0)
  matchLosses Int @default(0)

  kingdoms  Kingdom[]
  matches   MatchKingdom[]
}

model Kingdom {
  id             String    @id @default(uuid())
  name           String
  description    String?   // História ou descrição do reino (opcional)
  alignment      Alignment
  race           Race
  ownerId        String
  owner          User      @relation(fields: [ownerId], references: [id])
  // Relação direta com o Regente do Reino
  regentId       String?   @unique
  regent         Unit?     @relation("KingdomRegent", fields: [regentId], references: [id])
  // Templates das 5 tropas (permanentes)
  troopTemplates TroopTemplate[]
  // Histórico de partidas (resumo)
  matchHistory   MatchHistory[]
  // Partidas em que este reino participou
  matchKingdoms  MatchKingdom[]
  createdAt      DateTime  @default(now())
}

// Template de Tropa - Definido na criação do Reino
model TroopTemplate {
  id             String    @id @default(uuid())
  kingdomId      String
  kingdom        Kingdom   @relation(fields: [kingdomId], references: [id], onDelete: Cascade)
  slotIndex      Int       // 0-4 (5 tropas por reino)
  name           String    // Nome personalizado da tropa
  description    String?   // História ou descrição da tropa (opcional)
  avatar         String?   // ID do sprite (ex: "[1].png")
  passiveId      String    // ID da passiva escolhida
  resourceType   String    // minerio, suprimentos, arcana, experiencia
  // Atributos base (10 pontos distribuídos)
  combat         Int       @default(2)
  speed          Int       @default(2)
  focus          Int       @default(2)
  armor          Int       @default(2)
  vitality       Int       @default(2)
  
  @@unique([kingdomId, slotIndex])
}

enum Alignment {
  BOM
  MAL
  NEUTRO
}

enum Race {
  ABERRACAO
  BESTA
  CELESTIAL
  CONSTRUTO
  DRAGAO
  ELEMENTAL
  FADA
  DIABO
  GIGANTE
  HUMANOIDE
  MONSTRUOSIDADE
  GOSMA
  PLANTA
  MORTO_VIVO
  INSETO
}

model Match {
  id             String   @id @default(uuid())
  status         String   @default("WAITING")
  currentRound   Int      @default(1)
  currentTurn    TurnType @default(ADMINISTRACAO)
  crisisMeter    Int      @default(0)
  crisisState    String?
  recruitedHeroes String  @default("[]") // Códigos de heróis já recrutados nesta partida (JSON array)
  players        MatchKingdom[]
  territories    Territory[]
  units          Unit[]
  structures     Structure[]
  battles        Battle[]
  events         GameEvent[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// Histórico de partidas (resumo para o Reino)
model MatchHistory {
  id             String   @id @default(uuid())
  kingdomId      String
  kingdom        Kingdom  @relation(fields: [kingdomId], references: [id])
  matchDate      DateTime @default(now())
  result         String   // WIN | LOSS | DRAW
  opponentName   String   // Nome do reino oponente
  opponentRace   String   // Raça do oponente
  finalRound     Int      // Rodada em que a partida terminou
  summary        String   @default("{}") // JSON: estatísticas extras (unidades perdidas, etc)
}

// Reino participando de uma partida
model MatchKingdom {
  id             String   @id @default(uuid())
  matchId        String
  match          Match    @relation(fields: [matchId], references: [id])
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  kingdomId      String
  kingdom        Kingdom  @relation(fields: [kingdomId], references: [id])
  playerIndex    Int      @default(0)        // 0 = Host, 1 = Guest (define cor)
  playerColor    String   @default("#ff0000") // Vermelho padrão
  isReady        Boolean  @default(false)    // Pronto na fase de preparação
  freeBuildingsUsed Int   @default(0)        // Construções gratuitas usadas na preparação (máx 3)
  capitalTerritoryId String?                 // Território inicial/capital
  locationIndex  Int?                        // Posição no mapa (definida durante partida)
  troopLevels    String   @default("{}")
  troopTemplates String   @default("{}")
  customChoices  String   @default("{}")
  raceMetadata   String?                     // Metadata da raça (ex: elementos para Elemental)
  inventory      String   @default("[]")     // Itens do reino durante esta partida (JSON)
  resources      String   @default("{\"ore\":0,\"supplies\":0,\"arcane\":0,\"experience\":0,\"devotion\":0}")
  hasPlayedTurn  Boolean  @default(false)
  hasFinishedAdminTurn Boolean @default(false)
  unitCount      Int      @default(0)
  buildingCount  Int      @default(0)
  units          Unit[]
  structures     Structure[]
  battleUnits    BattleUnit[]
}

model Territory {
  id             String        @id @default(uuid())
  matchId        String
  match          Match         @relation(fields: [matchId], references: [id])
  mapIndex       Int
  centerX        Float         @default(0)
  centerY        Float         @default(0)
  type           String
  terrainType    String
  polygonData    String
  size           TerritorySize @default(MEDIUM)
  areaSlots      Int           @default(10)
  usedSlots      Int           @default(0)
  ownerId        String?       // ID do MatchKingdom que controla (null = selvagem)
  isCapital      Boolean       @default(false) // É a capital de algum jogador?
  hasCrisisIntel Boolean       @default(false)
  constructionCount Int        @default(0)     // Total de construções (Produtores + Fortalezas)
  fortressCount  Int           @default(0)     // Apenas fortalezas (máximo 3)
  isDisabled     Boolean       @default(false)
}

model Unit {
  id             String      @id @default(uuid())
  // Vinculação à Partida (quando em partida)
  matchId        String?
  match          Match?      @relation(fields: [matchId], references: [id])
  // Vinculação ao Reino na Partida (MatchKingdom)
  ownerId        String?
  owner          MatchKingdom? @relation(fields: [ownerId], references: [id])
  // Relação inversa: Este Unit pode ser o Regente de um Kingdom
  regentOfKingdom Kingdom?   @relation("KingdomRegent")
  name           String?
  description    String?     // História ou descrição do herói/regente (opcional)
  equipment      String      @default("[]") // Itens equipados (máx 3) (JSON)
  // Relacionamentos de unidades
  summonerId     String?
  summoner       Unit?        @relation("Summons", fields: [summonerId], references: [id])
  summons        Unit[]       @relation("Summons")
  battleUnits    BattleUnit[]
  // Dados da Unidade
  category       UnitCategory
  troopSlot      Int?         // Para TROOP: índice do template de tropa (0-4)
  level          Int          @default(1)
  experience     Int          @default(0) // XP acumulada - ao atingir thresholds, sobe de nível
  // Avatar (nome do arquivo sprite em public/sprites/Characters)
  avatar         String?      // ID do sprite (ex: "[1].png")
  // Classe do Herói (código string, ex: BARBARIAN, WARRIOR) - Regentes NÃO possuem classe
  classCode      String?      // Código da classe (dados em server/src/data/classes.data.ts)
  classFeatures  String       @default("[]") // IDs das skills aprendidas (Regentes escolhem de qualquer classe)
  spells         String       @default("[]") // Códigos das spells disponíveis (concedidas via eventos/skills)
  // Condições permanentes da unidade (ex: buffs de eventos, maldições, etc)
  conditions     String       @default("[]") // Códigos das condições ativas (JSON array)
  // Cooldowns de skills/spells entre batalhas
  unitCooldowns  String       @default("{}") // { code: turnosRestantes } (JSON object)
  combat         Int
  speed          Int
  focus          Int
  armor          Int
  vitality       Int
  damageReduction Int         @default(0) // Redução de dano fixa (armadura pesada, raça, etc.)
  currentHp      Int
  movesLeft      Int
  actionsLeft    Int
  isAlive        Boolean      @default(true) // Morte permanente em partidas
  locationIndex  Int?
  // NOTA: Campo 'actions' foi REMOVIDO - ações são calculadas em runtime
  // a partir de DEFAULT_UNIT_ACTIONS + skills ativas do classFeatures
}

model Structure {
  id             String      @id @default(uuid())
  // Vinculação à Partida (quando em partida)
  matchId        String?
  match          Match?      @relation(fields: [matchId], references: [id])
  // Vinculação ao Reino na Partida (MatchKingdom)
  ownerId        String?
  owner          MatchKingdom? @relation(fields: [ownerId], references: [id])
  // Dados da Estrutura
  type           String
  maxHp          Int
  currentHp      Int
  resourceType   String?
  productionRate Int
  locationIndex  Int?
}

enum UnitCategory {
  TROOP
  HERO
  REGENT
  PRISONER
  SUMMON
  MONSTER
}

enum TerritorySize {
  SMALL
  MEDIUM
  LARGE
}

enum TurnType {
  ADMINISTRACAO
  EXERCITOS
  MOVIMENTACAO
  CRISE
  ACAO
  BATALHA
}

// =====================
// Battle System Models
// =====================

// Arena Lobby - Sala de espera para batalhas PvP
model ArenaLobby {
  id             String   @id @default(uuid())
  hostUserId     String
  hostSocketId   String   @default("")
  hostKingdomId  String
  hostUsername   String   @default("")
  hostKingdomName String  @default("")
  guestUserId    String?
  guestSocketId  String?
  guestKingdomId String?
  guestUsername  String?
  guestKingdomName String?
  status         String   @default("WAITING") // WAITING | READY | BATTLING | ENDED
  battleId       String?  // ID da batalha quando status = BATTLING
  events         GameEvent[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Battle {
  id               String   @id @default(uuid())
  matchId          String?  // Null para batalhas de Arena
  match            Match?   @relation(fields: [matchId], references: [id])
  isArena          Boolean  @default(false)    // True se é batalha de Arena
  lobbyId          String?  // ID do lobby de Arena (se aplicável)
  hostUserId       String?  // ID do host da Arena
  guestUserId      String?  // ID do guest da Arena
  hostKingdomId    String?  // ID do reino do host
  guestKingdomId   String?  // ID do reino do guest
  status           String   @default("ACTIVE") // ACTIVE | ENDED
  gridWidth        Int      @default(20)
  gridHeight       Int      @default(20)
  round            Int      @default(1)
  currentTurnIndex Int      @default(0)        // índice na ordem de iniciativa
  actionOrder      String   @default("[]")      // JSON: [userId...], ordem de jogadores por iniciativa
  winnerId         String?  // ID do vencedor (userId ou matchKingdomId)
  winReason        String?  // Motivo da vitória
  ransomPrice      Int?
  ransomResource   String?
  // Clima e Terreno
  terrainType      String   @default("PLAINS")  // FOREST | PLAINS | MOUNTAIN | DESERT | ICE | WASTELAND | SWAMP | RUINS
  territorySize    TerritorySize   @default(MEDIUM)  // SMALL | MEDIUM | LARGE
  obstacles        String   @default("[]")      // JSON: [{id, posX, posY, emoji}...]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  units            BattleUnit[]
  logs             BattleLog[]
  events           GameEvent[]
}

model BattleUnit {
  id          String      @id @default(uuid())
  battleId    String
  battle      Battle      @relation(fields: [battleId], references: [id], onDelete: Cascade)
  unitId      String?     // Reference to original Unit (null for Arena where units are temporary)
  unit        Unit?       @relation(fields: [unitId], references: [id])
  ownerId     String?     // MatchKingdom ID (for matches)
  owner       MatchKingdom? @relation(fields: [ownerId], references: [id])
  // Data copied from Unit for battle
  userId      String?     // Owner User ID (for Arena)
  kingdomId   String?     // Owner Kingdom ID
  name        String      @default("Unit")
  avatar      String?     // ID do sprite (ex: "[1].png")
  category    String      @default("TROOP")
  troopSlot   Int?        // Para TROOP: índice do template (0-4)
  level       Int         @default(1)  // Nível da unidade
  classCode   String?     // Código da classe (ex: BARBARIAN, WARRIOR)
  classFeatures String    @default("[]") // Skills aprendidas (JSON)
  equipment   String      @default("[]") // Itens equipados (JSON)
  spells      String      @default("[]") // Códigos das spells disponíveis (JSON)
  combat      Int         @default(1)
  speed       Int         @default(1)
  focus       Int         @default(1)
  armor       Int         @default(1)
  vitality    Int         @default(5)
  damageReduction Int     @default(0) // Fixed DR, most units have 0
  currentHp   Int         @default(10)  // vitality * 2
  // Battle state
  posX        Int         @default(0)
  posY        Int         @default(0)
  initiative  Int         @default(0)
  movesLeft   Int         @default(3)
  actionsLeft Int         @default(1)
  attacksLeftThisTurn Int @default(0)          // Ataques restantes neste turno (extraAttacks)
  isAlive     Boolean     @default(true)
  actionMarks Int         @default(0)          // Accumulated Action Marks
  protection  Int         @default(0)          // Current protection (2x Armor at start)
  protectionBroken Boolean @default(false)     // Cannot be recovered if broken
  conditions  String      @default("[]")        // JSON: ["FROZEN", ...]
  grabbedByBattleUnitId String?
  corpseRemoved Boolean   @default(false)      // If true, corpse no longer blocks
  hasStartedAction Boolean @default(false)     // If unit already started action this turn
  actions     String      @default("[\"attack\",\"move\",\"dash\",\"dodge\"]") // Available actions (copied from Unit)
  isAIControlled Boolean  @default(false)     // If true, AI controls this unit (funnel)
  // Unit size and vision
  size        String      @default("NORMAL")   // NORMAL | LARGE | HUGE | GARGANTUAN
  visionRange Int         @default(10)         // Vision range (max(10, focus))
  // Skill/Spell cooldowns
  unitCooldowns String     @default("{}")       // JSON: { "CODE": roundsLeft }
}

model BattleLog {
  id        String   @id @default(uuid())
  battleId  String
  battle    Battle   @relation(fields: [battleId], references: [id])
  timestamp DateTime @default(now())
  type      String   // MOVE | ATTACK | END_TURN | START | END
  payload   String   @default("{}") // JSON string com detalhes
}

// =============================================================================
// SISTEMA DE EVENTOS
// =============================================================================

model GameEvent {
  id          String   @id @default(uuid())
  timestamp   DateTime @default(now())
  
  // Contexto e escopo
  context     String   // GLOBAL | MATCH | BATTLE | ARENA | ACCOUNT
  scope       String   // GLOBAL | INDIVIDUAL
  category    String   // SYSTEM | COMBAT | MOVEMENT | CONDITION | TURN | SKILL | ITEM | RESOURCE | KINGDOM | MATCH | ARENA | ACCOUNT
  severity    String   @default("INFO") // INFO | SUCCESS | WARNING | DANGER | NEUTRAL
  
  // Relacionamentos (apenas um preenchido por vez)
  matchId       String?
  match         Match?      @relation(fields: [matchId], references: [id], onDelete: Cascade)
  battleId      String?
  battle        Battle?     @relation(fields: [battleId], references: [id], onDelete: Cascade)
  arenaLobbyId  String?
  arenaLobby    ArenaLobby? @relation(fields: [arenaLobbyId], references: [id], onDelete: Cascade)
  
  // Destinatários
  targetUserIds String   @default("[]") // JSON: ["userId1", "userId2"] - Se scope=INDIVIDUAL
  sourceUserId  String?  // Usuário que originou o evento
  
  // Conteúdo
  message   String   // Mensagem principal para exibição
  code      String   // Código identificador (ex: ATTACK_DODGED)
  data      String   @default("{}") // JSON: dados extras
  
  // Unidades envolvidas (para eventos de combate)
  actorId   String?
  actorName String?
  targetId  String?
  targetName String?
  
  // Índices otimizados para queries comuns
  @@index([matchId, timestamp(sort: Desc)])
  @@index([battleId, timestamp(sort: Desc)])
  @@index([arenaLobbyId, timestamp(sort: Desc)])
  @@index([context, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])  // Para paginação e cleanup
}