generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  kingdoms Kingdom[]
  matches  MatchPlayer[]
}

model Kingdom {
  id             String          @id @default(uuid())
  name           String
  capitalName    String
  description    String? // História ou descrição do reino (opcional)
  alignment      Alignment
  race           Race
  raceMetadata   String?
  locationIndex  Int
  ownerId        String
  owner          User            @relation(fields: [ownerId], references: [id])
  matchHistory   MatchPlayer[]
  units          Unit[] // Regentes e unidades permanentes do reino
  structures     Structure[] // Estruturas permanentes do reino
  troopTemplates TroopTemplate[] // Templates das 5 tropas do reino
  inventory      String          @default("[]") // Itens do reino (JSON)
  createdAt      DateTime        @default(now())
}

// Template de Tropa - Definido na criação do Reino
model TroopTemplate {
  id           String  @id @default(uuid())
  kingdomId    String
  kingdom      Kingdom @relation(fields: [kingdomId], references: [id], onDelete: Cascade)
  slotIndex    Int // 0-4 (5 tropas por reino)
  name         String // Nome personalizado da tropa
  description  String? // História ou descrição da tropa (opcional)
  passiveId    String // ID da passiva escolhida
  resourceType String // minerio, suprimentos, arcana, experiencia
  // Atributos base (10 pontos distribuídos)
  combat       Int     @default(2)
  acuity       Int     @default(2)
  focus        Int     @default(2)
  armor        Int     @default(2)
  vitality     Int     @default(2)

  @@unique([kingdomId, slotIndex])
}

enum Alignment {
  BOM
  MAL
  NEUTRO
}

enum Race {
  ABERRACAO
  BESTA
  CELESTIAL
  CONSTRUTO
  DRAGAO
  ELEMENTAL
  FADA
  DIABO
  GIGANTE
  HUMANOIDE
  MONSTRUOSIDADE
  GOSMA
  PLANTA
  MORTO_VIVO
  INSETO
}

model Match {
  id           String        @id @default(uuid())
  status       String        @default("WAITING")
  currentRound Int           @default(1)
  currentTurn  TurnType      @default(ADMINISTRACAO)
  crisisMeter  Int           @default(0)
  crisisState  String?
  players      MatchPlayer[]
  territories  Territory[]
  units        Unit[]
  structures   Structure[]
  battles      Battle[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model MatchPlayer {
  id                   String       @id @default(uuid())
  matchId              String
  match                Match        @relation(fields: [matchId], references: [id])
  userId               String
  user                 User         @relation(fields: [userId], references: [id])
  kingdomId            String
  kingdom              Kingdom      @relation(fields: [kingdomId], references: [id])
  playerIndex          Int          @default(0) // 0 = Host, 1 = Guest (define cor)
  playerColor          String       @default("#ff0000") // Vermelho padrão
  isReady              Boolean      @default(false) // Pronto na fase de preparação
  freeBuildingsUsed    Int          @default(0) // Construções gratuitas usadas na preparação (máx 3)
  capitalTerritoryId   String? // Território inicial/capital
  troopLevels          String       @default("{}")
  troopTemplates       String       @default("{}")
  customChoices        String       @default("{}")
  resources            String       @default("{\"minerio\":0,\"suprimentos\":0,\"arcana\":0,\"experiencia\":0,\"devocao\":0}")
  hasPlayedTurn        Boolean      @default(false)
  hasFinishedAdminTurn Boolean      @default(false)
  unitCount            Int          @default(0)
  buildingCount        Int          @default(0)
  units                Unit[]
  structures           Structure[]
  battleUnits          BattleUnit[]
}

model Territory {
  id                String        @id @default(uuid())
  matchId           String
  match             Match         @relation(fields: [matchId], references: [id])
  mapIndex          Int
  centerX           Float         @default(0)
  centerY           Float         @default(0)
  type              String
  terrainType       String
  polygonData       String
  size              TerritorySize @default(MEDIUM)
  areaSlots         Int           @default(10)
  usedSlots         Int           @default(0)
  ownerId           String? // ID do MatchPlayer que controla (null = selvagem)
  isCapital         Boolean       @default(false) // É a capital de algum jogador?
  hasCrisisIntel    Boolean       @default(false)
  constructionCount Int           @default(0) // Total de construções (Produtores + Fortalezas)
  fortressCount     Int           @default(0) // Apenas fortalezas (máximo 3)
  isDisabled        Boolean       @default(false)
}

model Unit {
  id              String       @id @default(uuid())
  // Vinculação ao Reino (proprietário permanente)
  kingdomId       String?
  kingdom         Kingdom?     @relation(fields: [kingdomId], references: [id])
  // Vinculação à Partida (quando o reino está jogando)
  matchId         String?
  match           Match?       @relation(fields: [matchId], references: [id])
  // Vinculação ao Jogador na Partida (quando em partida)
  ownerId         String?
  owner           MatchPlayer? @relation(fields: [ownerId], references: [id])
  name            String?
  description     String? // História ou descrição do herói/regente (opcional)
  equipment       String       @default("[]") // Itens equipados (máx 3) (JSON)
  // Relacionamentos de unidades
  summonerId      String?
  summoner        Unit?        @relation("Summons", fields: [summonerId], references: [id])
  summons         Unit[]       @relation("Summons")
  battleUnits     BattleUnit[]
  // Dados da Unidade
  category        UnitCategory
  troopSlot       Int? // Para TROOP: índice do template de tropa (0-4)
  level           Int          @default(1)
  // Classe do Herói/Regente (referência à table HeroClass)
  classId         String?
  heroClass       HeroClass?   @relation(fields: [classId], references: [id])
  classFeatures   String       @default("[]") // IDs das skills aprendidas
  combat          Int
  acuity          Int
  focus           Int
  armor           Int
  vitality        Int
  damageReduction Int          @default(0) // Redução de dano fixa (armadura pesada, raça, etc.)
  currentHp       Int
  movesLeft       Int
  actionsLeft     Int
  isAlive         Boolean      @default(true) // Morte permanente em partidas
  locationIndex   Int?
  // Ações disponíveis para esta unidade (JSON array de strings)
  actions         String       @default("[\"attack\",\"move\",\"dash\",\"dodge\"]")
}

model Structure {
  id             String       @id @default(uuid())
  // Vinculação ao Reino (proprietário permanente)
  kingdomId      String?
  kingdom        Kingdom?     @relation(fields: [kingdomId], references: [id])
  // Vinculação à Partida (quando o reino está jogando)
  matchId        String?
  match          Match?       @relation(fields: [matchId], references: [id])
  // Vinculação ao Jogador na Partida (quando em partida)
  ownerId        String?
  owner          MatchPlayer? @relation(fields: [ownerId], references: [id])
  // Dados da Estrutura
  type           String
  maxHp          Int
  currentHp      Int
  resourceType   String?
  productionRate Int
  locationIndex  Int?
}

// =====================
// Hero Classes & Skills
// =====================

model HeroClass {
  id           String    @id @default(uuid())
  code         String    @unique // Ex: BARBARIAN, WARRIOR, CLERIC
  name         String // Nome de exibição
  description  String? // Descrição da classe
  archetype    Archetype // PHYSICAL, SPIRITUAL, ARCANE
  resourceUsed String // Recurso gasto para usar skills (FOOD, DEVOTION, ARCANA)

  // Relacionamentos
  skills Skill[] // Skills desta classe
  units  Unit[] // Unidades com esta classe

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Skill {
  id          String @id @default(uuid())
  code        String @unique // Ex: BARBARIAN_WILD_FURY
  name        String // Nome de exibição
  description String // O que a skill faz

  // Tipo e custo
  category SkillCategory // PASSIVE, ACTIVE, REACTIVE
  costTier CostTier? // LOW, MEDIUM, HIGH, EXTREME (null para passivas)
  range    SkillRange? // SELF, ADJACENT, RANGED, AREA

  // Vínculo à classe
  classId   String
  heroClass HeroClass @relation(fields: [classId], references: [id])

  // Função que será executada (nome do handler)
  functionName String? // Ex: "executeWildFury", "executeActionSurge"

  // Metadata adicional (JSON para parâmetros extras)
  metadata String @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Archetype {
  PHYSICAL // Física - usa Comida
  SPIRITUAL // Espiritual - usa Devoção  
  ARCANE // Arcana - usa Arcana
}

enum SkillCategory {
  PASSIVE // Sempre ativa
  ACTIVE // Requer ação para usar
  REACTIVE // Pode ser usada como reação
}

enum CostTier {
  LOW // Custo baixo
  MEDIUM // Custo médio
  HIGH // Custo alto
  EXTREME // Custo extremo
}

enum SkillRange {
  SELF // Afeta apenas o usuário
  ADJACENT // Afeta adjacentes
  RANGED // Afeta à distância
  AREA // Afeta área
}

enum UnitCategory {
  TROOP
  HERO
  REGENT
  PRISONER
  SUMMON
  MONSTER
}

enum TerritorySize {
  SMALL
  MEDIUM
  LARGE
}

enum TurnType {
  ADMINISTRACAO
  EXERCITOS
  MOVIMENTACAO
  CRISE
  ACAO
  BATALHA
}

// =====================
// Battle System Models
// =====================

model Battle {
  id               String       @id @default(uuid())
  matchId          String? // Null para batalhas de Arena
  match            Match?       @relation(fields: [matchId], references: [id])
  isArena          Boolean      @default(false) // True se é batalha de Arena
  lobbyId          String? // ID do lobby de Arena (se aplicável)
  hostUserId       String? // ID do host da Arena
  guestUserId      String? // ID do guest da Arena
  hostKingdomId    String? // ID do reino do host
  guestKingdomId   String? // ID do reino do guest
  status           String       @default("ACTIVE") // ACTIVE | ENDED
  gridWidth        Int          @default(20)
  gridHeight       Int          @default(20)
  round            Int          @default(1)
  currentTurnIndex Int          @default(0) // índice na ordem de iniciativa
  initiativeOrder  String       @default("[]") // JSON: [battleUnitId...]
  actionOrder      String       @default("[]") // JSON: [userId...], ordem de jogadores por iniciativa
  winnerId         String? // ID do vencedor (userId ou matchPlayerId)
  winReason        String? // Motivo da vitória
  ransomPrice      Int?
  ransomResource   String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  units            BattleUnit[]
  logs             BattleLog[]
}

model BattleUnit {
  id                    String       @id @default(uuid())
  battleId              String
  battle                Battle       @relation(fields: [battleId], references: [id], onDelete: Cascade)
  unitId                String? // Reference to original Unit (null for Arena where units are temporary)
  unit                  Unit?        @relation(fields: [unitId], references: [id])
  ownerId               String? // MatchPlayer ID (for matches)
  owner                 MatchPlayer? @relation(fields: [ownerId], references: [id])
  // Data copied from Unit for battle
  userId                String? // Owner User ID (for Arena)
  kingdomId             String? // Owner Kingdom ID
  name                  String       @default("Unit")
  category              String       @default("TROOP")
  troopSlot             Int? // Para TROOP: índice do template (0-4)
  level                 Int          @default(1) // Nível da unidade
  classId               String? // ID da classe do herói/regente
  classFeatures         String       @default("[]") // Skills aprendidas (JSON)
  equipment             String       @default("[]") // Itens equipados (JSON)
  combat                Int          @default(1)
  acuity                Int          @default(1)
  focus                 Int          @default(1)
  armor                 Int          @default(1)
  vitality              Int          @default(5)
  damageReduction       Int          @default(0) // Fixed DR, most units have 0
  currentHp             Int          @default(10) // vitality * 2
  // Battle state
  posX                  Int          @default(0)
  posY                  Int          @default(0)
  initiative            Int          @default(0)
  movesLeft             Int          @default(3)
  actionsLeft           Int          @default(1)
  isAlive               Boolean      @default(true)
  actionMarks           Int          @default(0) // Accumulated Action Marks
  protection            Int          @default(0) // Current protection (2x Armor at start)
  protectionBroken      Boolean      @default(false) // Cannot be recovered if broken
  conditions            String       @default("[]") // JSON: ["FROZEN", ...]
  grabbedByBattleUnitId String?
  corpseRemoved         Boolean      @default(false) // If true, corpse no longer blocks
  hasStartedAction      Boolean      @default(false) // If unit already started action this turn
  actions               String       @default("[\"attack\",\"move\",\"dash\",\"dodge\"]") // Available actions (copied from Unit)
}

model BattleLog {
  id        String   @id @default(uuid())
  battleId  String
  battle    Battle   @relation(fields: [battleId], references: [id])
  timestamp DateTime @default(now())
  type      String // MOVE | ATTACK | END_TURN | START | END
  payload   String   @default("{}") // JSON string com detalhes
}
